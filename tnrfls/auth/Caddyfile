{
    #global settings for all site blocks
    http_port 8080
    https_port 8443
    servers {
        timeouts {
            read_body 900s
            write 900s
        }
    }
}

{$FQDN} {
    request_body max_size 16KB
    encode zstd gzip

    @match_oauth2 path /oauth2/*
    @match_services2protect path /files* /stats*
    @match_allelse

    handle @match_oauth2 {
        reverse_proxy auth:4180 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Uri {uri}
        }
    }

    handle @match_services2protect {
        forward_auth auth:4180 {
            uri /oauth2/auth
            header_up X-Real-IP {remote_host}
            @match_notyetauth status 401
			handle_response @match_notyetauth {
				redir * {scheme}://{host}/oauth2/sign_in?rd={scheme}://{host}{uri}
			}
        }

        handle /files* {
            request_body max_size 2GB
            rewrite * /stats/tfm/tfm.php
            php_fastcgi stats:9000
        }

        handle /stats* {
            reverse_proxy stats:7681
        }
    }

    handle @match_allelse {
        respond 404
    }
}
